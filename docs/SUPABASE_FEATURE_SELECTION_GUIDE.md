# Supabase 功能机制选型对照表

## 1. 核心机制 "心法" 速查

为了选择最适合的技术方案，我们根据业务场景的实时性、触发源和交互方向，将 Supabase 的三大核心机制区分如下：

| 机制 | 类型 | 适用场景 | 代表性例子 |
| :--- | :--- | :--- | :--- |
| **RPC (Functions)** | **主动拉取 (Pull)** | 非实时、复杂查询、写操作、事务提交 | 查看历史订单、提交设置表单、用户注册 |
| **Realtime** | **被动接收 (Push)** | **前端页面**需即时感知变化、轻量级通知 | 聊天消息、股票价格跳动、信号列表自动刷新 |
| **Db Webhook** | **后台触发 (Trigger)** | **后端服务**需自动化执行、脱离前端存在 | 自动跟单下单、发送邮件/短信、第三方系统回调 |

---

## 2. 页面/功能模块详细对照表 (基于当前项目结构)

| 页面/功能模块 | 对应文件路径 | 推荐机制 | 详细选型原因分析 |
| :--- | :--- | :--- | :--- |
| **1. 交易信号列表** | `index.tsx` (Home) | **Realtime + RPC (混合)** | **混合策略最佳**。<br>1. **RPC** 用于首屏加载（加载历史最后 20 条），利用数据库索引快速返回。<br>2. **Realtime** 监听 `INSERT` 事件，当新信号产生时，直接将数据推送到前端数组头部。这样用户无需下拉刷新即可看到最新机会，体验极佳。 |
| **2. 交易员主页/列表** | `trader/index.tsx` | **RPC** | 交易员的统计数据（如胜率、收益率）通常不需要秒级变动（一般是 T+1 或小时级更新）。前端使用 RPC 分页拉取数据即可，无需维持 Realtime 长连接。 |
| **3. 跟单设置/订阅** | `trader/detail.tsx` | **RPC** | 用户点击“开启跟单”是一个明确的**写操作**（向 `trader_followers` 表插入数据）。前端需要等待操作结果（成功提示或错误弹窗），RPC 是最标准的请求-响应模式。 |
| **4. 实盘跟单执行** | (后台逻辑, 无页面) | **Db Webhook** | **核心业务逻辑**。<br>跟单动作必须由**数据库**触发，绝对不能依赖前端页面（如果用户没打开 App 也要能自动下单）。Webhook 监听到新信号后，直接调用 Edge Function 执行下单。 |
| **5. 收益回测跑批** | (后台逻辑, 无页面) | **pg_cron + RPC** | 这是一个定时任务（Scheduler），每 5 分钟触发一次。不需要任何实时性，只需要稳定地调用 Edge Function 进行批量计算。 |
| **6. 我的订阅/跟单记录** | `purchase-history.tsx` | **RPC** | 这是一个“历史档案库”类型的页面。用户通常只会点进去看一次，或者偶尔查询。数据量可能很大，需要依赖 SQL 的分页查询 (`OFFSET`, `LIMIT`)，RPC 最合适。 |
| **7. 个人资产/余额** | `(tabs)/my.tsx` | **RPC** | 虽然用户希望资产“实时”变化，但实际上获取余额通常需要调用交易所 API，比较重。为了性能，通常采用“进入页面加载一次”或“下拉刷新”触发 RPC 的方式，而不是一直维持实时连接。 |
| **8. 新信号系统通知** | (App 全局) | **Db Webhook** | 即使 App 被杀死（Kill Background），用户也要能收到通知。<br>因此需要 Webhook 触发后端服务，后端调用 Apple APNs / FCM 发送系统级推送通知。 |
| **9. 交易所账户绑定** | `profile/exchange-accounts` | **RPC** | **安全敏感操作**。<br>保存 API Key 和 Secret 必须经过加密处理。RPC 可以在服务端进行加密后再存入数据库，确保密钥即便在数据库泄露也是安全的。 |
| **10. 信号详情页 (实时盈亏)** | `trader/detail.tsx` (or SignalCard) | **Realtime** | 如果用户停留在信号卡片上，他可能想实时盯着这单目前的盈亏状态（Open -> Closed）。Realtime 监听该信号行的 `UPDATE` 事件，可以让用户眼睁睁看着状态变掉，增加紧迫感和互动性。 |

---

## 3. 架构师建议总结

1.  **前端展示 (UI)**：
    *   绝大多数页面（80%）应使用 **RPC** (Supabase Client SDK: `supabase.from('...').select()`)。
    *   只有首页的信息流、K 线跳动等强时效性组件才引入 **Realtime**。

2.  **后端逻辑 (Backend)**：
    *   涉及“钱”和“自动化”的业务（跟单、发通知），必须下沉到 **Database Webhook** 层。
    *   涉及“统计”和“清洗”的业务（回测、排行榜计算），使用 **pg_cron** 定时处理。
